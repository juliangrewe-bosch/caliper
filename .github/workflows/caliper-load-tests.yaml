name: 'Caliper-Load-Tests'

on:
  push:
  workflow_dispatch:

concurrency:
  group: "Caliper"
  cancel-in-progress: false

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  caliper:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          path: caliper

      - uses: actions/checkout@v3 # TODO replace with carbynestack/IaC
        with:
          repository: juliangrewe-bosch/carbynestack
          token: ${{secrets.CALIPER_PRIVATE_REPOS_PAT}}
          ref: cdktf-caliper
          path: carbynestack

      - uses: actions/setup-node@v3
        with:
          node-version: "16"

      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - run: npm install --global cdktf-cli@0.16.3

      - name: Provision AzureVM
        id: provision-vm
        run: |
          npm install
          cdktf get
          cdktf synth
          terraform -chdir=cdktf.out/stacks/private-aks/ init -input=false
          terraform -chdir=cdktf.out/stacks/private-aks/ apply -auto-approve -input=false
        working-directory: carbynestack/deployments
        env:
          TF_VAR_adminPassword: ${{ secrets.ADMIN_PASSWORD }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get AzureVM IP Address
        id: get-ip
        run: |
          AZURE_VM_IP=$(terraform -chdir=cdktf.out/stacks/private-aks/ output -raw caliper-vm-public-ip)
          echo "AZURE_VM_IP=$AZURE_VM_IP" >> $GITHUB_ENV
        working-directory: carbynestack/deployments

      - name: Test
        run: echo "Azure VM IP Address  $AZURE_VM_IP"

      - name: Run load-tests
        id: load-tests
        run: |
          # Update package repositories and install necessary tools
          sudo apt-get update > /dev/null
          sudo apt-get install sshpass unzip -y

          # SSH into the remote server using sshpass and execute script
          sshpass -p ${{ secrets.ADMIN_PASSWORD }} ssh -o "StrictHostKeyChecking no" \
          caliper@${{ env.AZURE_VM_IP }} \
          "export CALIPER_PAT=${{ secrets.CALIPER_PAT }}; \
          export CALIPER_PRIVATE_REPOS_PAT=${{ secrets.CALIPER_PRIVATE_REPOS_PAT }}; \
          export AZURE_CLIENT_ID=${{ secrets.AZURE_CLIENT_ID }}; \
          export AZURE_CLIENT_SECRET=${{ secrets.AZURE_CLIENT_SECRET }}; \
          export AZURE_TENANT_ID=${{ secrets.AZURE_TENANT_ID }}; \
          export AZURE_SUBSCRIPTION_ID=${{ secrets.AZURE_SUBSCRIPTION_ID }}; \
          bash -s" < scripts/run_caliper_load_tests.sh
        working-directory: caliper

  destroy:
    needs: caliper
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure CLI script
        uses: azure/CLI@v1
        with:
          azcliversion: 2.30.0
          inlineScript: |
            az group delete --name caliper-rg --yes
